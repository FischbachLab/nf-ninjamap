includeConfig "$baseDir/conf/aws_batch.config"

manifest {
  name = 'NinjaMap nextflow pipeline'
  author = 'Sunit Jain & Xiandong Meng'
  homePage = 'https://github.com/fischbachlab/nf-ninjamap'
  description = 'Calculate strain abundance in a defined community'
  mainScript = 'main.nf'
  version = '2.0'
  defaultBranch = 'dev' //github branch
}

process {
  executor = 'awsbatch' // 'local' 
  queue = "default-maf-pipelines"
  cleanup = true
  //container = '423543210473.dkr.ecr.us-west-2.amazonaws.com/fischbach_lab/ninjamap:20210828043637'
  //container = 'fischbachlab/nf-ninjamap:latest'
  errorStrategy = { task.exitStatus in [143,137,104,134,139] ? 'retry' : 'finish' }
  cache = false

  //cpus = { check_max( 1 * task.attempt, 'cpus' ) }
  //memory = { check_max( 8.GB * task.attempt, 'memory' ) }
  //time = { check_max( 8.h * task.attempt, 'time' ) }
  //maxErrors = '-1'

}

aws {
  region = "us-west-2"
}

//aws.batch.cliPath = '/home/ec2-user/miniconda3/bin/aws'

params{
  /*
 * Defines the pipeline inputs parameters (giving a default value for each for them)
 * Each of the following parameters can be specified as command line options
 */
 /* 	Initialization
  --------------------------------*/
  seedfile = ""
  project = "TEST"
  ref_db_path = "/mnt/efs/databases/Bowtie2" // mounted reference db
  db = "HCom2_20221117"
  db_prefix = "HCom2"
  db_path = "s3://maf-versioned/ninjamap/Index"
  // external url: https://zenodo.org/record/7872423/files/hCom2_20221117.ninjaIndex.tar.gz
  output_path = "s3://genomics-workflow-core/Results/Ninjamap"
  sampleRate = 1
  coreNum = 8
  memPerCore = "2G"

  // QC parameters
  minQuality = 30   
  minLength = 50

  container = '458432034220.dkr.ecr.us-west-2.amazonaws.com/nf-ninjamap:20220729115816'
  //container = 'fischbachlab/nf-ninjamap:latest'. //local
  container_R ='458432034220.dkr.ecr.us-west-2.amazonaws.com/ninjamap-aggregation:20250315115604'
  //container_R ='fischbachlab/ninjamap-aggregation:20250315115604'. //local
  container_Bio ='458432034220.dkr.ecr.us-west-2.amazonaws.com/py-parallel:latest'
  // set to 1 if enabling the debug mode 
  // coverage must set to 1 if enabling the debug mode
  debug = 0 // for generate singular&escrow bam files for each genome
  coverage = 0  // set to 1 if enableing the singular and escrow coverages, respectively

  mask = null // if performing genome masking
  //minimum singular vote per strain
  min_singular_vote = 0  //NOT working with coverage and debug options
  alignmentThres = 95 // check host contamination if less than this alignment threshod
  check_human = true // force to check human contamination regardless of the alignment rate
  check_mouse = true // force to check mouse contamination regardless of the alignment rate

  plot = true        // if generating the plots
  auto_sampling = true // automatically downsampling if the input fastq is over the processing limit
}

docker.enabled = true

profiles {
  //awsbatch { includeConfig 'conf/aws_batch.config' }
  //conda { process.conda = "$baseDir/environment.yml" }
  debug { process.beforeScript = 'echo $HOSTNAME' }
  docker { docker.enabled = true }
  //singularity { singularity.enabled = true }
  //test { includeConfig 'conf/test.config' }
}


timeline {
  enabled = false
  overwrite = true
  file = "$params.output_path/execution_reports/timeline.html"
}

report {
  enabled = false
  overwrite = true
  file = "$params.output_path/execution_reports/report.html"
}

dag {
    enabled = false
    overwrite = true
    file = "$params.output_path/execution_reports/pipeline_dag.html"
}
